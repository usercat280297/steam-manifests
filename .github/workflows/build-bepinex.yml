name: Build BepInEx Plugin

on:
  push:
    paths:
      - 'devour_vi_bepinex_plugin/**'
      - '.github/workflows/build-bepinex.yml'
  workflow_dispatch:
  pull_request:
    paths:
      - 'devour_vi_bepinex_plugin/**'

jobs:
  build:
    runs-on: windows-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '6.0.x'
      
      - name: Download BepInEx
        working-directory: ./devour_vi_bepinex_plugin
        shell: pwsh
        run: |
          # Try multiple download sources
          $urls = @(
            "https://github.com/BepInEx/BepInEx/releases/download/v5.4.21/BepInEx_5.4.21.zip",
            "https://github.com/BepInEx/BepInEx/releases/download/v5.4.21/BeInEx_5.4.21.zip"
          )
          
          foreach ($url in $urls) {
            try {
              Write-Host "Trying: $url"
              Invoke-WebRequest -Uri $url -OutFile "BepInEx.zip" -UseBasicParsing
              Write-Host "✓ Downloaded successfully"
              break
            } catch {
              Write-Host "✗ Failed, trying next..."
            }
          }
          
          # Extract
          Add-Type -AssemblyName System.IO.Compression.FileSystem
          [System.IO.Compression.ZipFile]::ExtractToDirectory("BepInEx.zip", ".")
          
          # Copy DLLs to lib folder
          if (-not (Test-Path "lib")) { mkdir "lib" | Out-Null }
          
          # Try different possible paths
          $paths = @(
            "BepInEx\core",
            "BepInEx\",
            "core"
          )
          
          foreach ($path in $paths) {
            if (Test-Path $path) {
              Write-Host "Found core at: $path"
              Get-ChildItem -Path $path -Filter "*.dll" | ForEach-Object {
                Copy-Item -Path $_.FullName -Destination "lib\" -Force
                Write-Host "  Copied: $($_.Name)"
              }
              break
            }
          }
          
          Remove-Item "BepInEx.zip" -Force -ErrorAction SilentlyContinue
          Write-Host "✓ BepInEx setup complete"
      
      - name: Restore dependencies
        working-directory: ./devour_vi_bepinex_plugin
        run: dotnet restore
      
      - name: Build Release
        working-directory: ./devour_vi_bepinex_plugin
        run: dotnet build -c Release --no-restore
      
      - name: Upload artifact
        uses: actions/upload-artifact@v3
        with:
          name: DevourVietnamesePatch
          path: devour_vi_bepinex_plugin/bin/Release/net472/DevourVietnamesePatch.dll
          retention-days: 30
      
      - name: Create Release (on tag)
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: devour_vi_bepinex_plugin/bin/Release/net472/DevourVietnamesePatch.dll
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}


